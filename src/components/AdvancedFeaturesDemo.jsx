/**
 * Composant de test pour les nouvelles fonctionnalit√©s avanc√©es
 * Scanner Frigo + Meal Planning + Gamification
 */

import React, { useState, useEffect } from 'react';
import { useAuth } from '../hooks/useAuth';
import './AdvancedFeaturesDemo.css';

// Import conditionnel des services pour √©viter les erreurs
let fridgeScannerService, mealPlanningService, gamificationService, integratedFeaturesService;

try {
  fridgeScannerService = require('../services/fridgeScannerService').default;
  mealPlanningService = require('../services/mealPlanningService').default;
  gamificationService = require('../services/gamificationService').default;
  integratedFeaturesService = require('../services/integratedFeaturesService').default;
} catch (error) {
  console.warn('Certains services avanc√©s ne sont pas disponibles:', error.message);
}

const AdvancedFeaturesDemo = () => {
  const { user } = useAuth();
  const userId = user?.uid || 'demo_user';
  
  const [activeDemo, setActiveDemo] = useState('scanner');
  const [loading, setLoading] = useState(false);
  const [results, setResults] = useState(null);
  const [userPoints, setUserPoints] = useState(0);
  const [userBadges, setUserBadges] = useState([]);
  const [servicesAvailable, setServicesAvailable] = useState(false);

  useEffect(() => {
    // V√©rifier si les services sont disponibles
    const available = !!(fridgeScannerService && mealPlanningService && gamificationService && integratedFeaturesService);
    setServicesAvailable(available);
    
    if (available) {
      loadUserGamificationData();
    }
  }, [userId]);

  const loadUserGamificationData = async () => {
    if (!gamificationService) return;
    
    try {
      const userData = await gamificationService.getUserData(userId);
      const badges = await gamificationService.getUserBadges(userId);
      setUserPoints(userData.totalScore || 0);
      setUserBadges(badges);
    } catch (error) {
      console.error('Erreur chargement donn√©es gamification:', error);
    }
  };
  // ===================
  // DEMO SCANNER FRIGO
  // ===================
  const handleFridgeScan = async (event) => {
    const file = event.target.files[0];
    if (!file || !integratedFeaturesService) return;

    setLoading(true);
    try {
      console.log('üîç D√©marrage d√©mo scanner frigo...');
      
      // Simuler un scan r√©ussi si les services ne sont pas disponibles
      if (!servicesAvailable) {
        await new Promise(resolve => setTimeout(resolve, 2000));
        setResults({
          type: 'fridge_scan',
          data: {
            fridgeScan: {
              detectedIngredients: [
                { name: 'tomates', quantity: '4', freshness: 85 },
                { name: '≈ìufs', quantity: '6', freshness: 90 },
                { name: 'fromage', quantity: '150g', freshness: 80 }
              ],
              suggestedRecipes: [
                { name: 'Omelette aux tomates', fridgeUsage: 95 }
              ]
            },
            scanReward: { pointsEarned: 15, newBadges: [] }
          },
          timestamp: new Date().toISOString()
        });
        return;
      }
      
      // Utiliser le workflow int√©gr√©
      const workflowResult = await integratedFeaturesService.executeCompleteWorkflow(
        userId, 
        'fridge_to_meal_plan', 
        { imageFile: file, planDuration: 'weekly' }
      );

      setResults({
        type: 'fridge_scan',
        data: workflowResult.results,
        timestamp: new Date().toISOString()
      });

      // Mettre √† jour les points
      await loadUserGamificationData();

    } catch (error) {
      console.error('Erreur d√©mo scanner:', error);
      setResults({
        type: 'error',
        message: error.message
      });
    } finally {
      setLoading(false);
    }
  };
  // ===================
  // DEMO MEAL PLANNING
  // ===================
  const handleGenerateMealPlan = async () => {
    setLoading(true);
    try {
      console.log('üìÖ D√©marrage d√©mo meal planning...');
      
      if (!servicesAvailable) {
        await new Promise(resolve => setTimeout(resolve, 2000));
        setResults({
          type: 'meal_plan',
          data: {
            mealPlan: {
              planId: 'demo_plan',
              title: 'Plan √âquilibr√© (D√©mo)',
              days: [
                { date: '2024-01-01', meals: { breakfast: { name: 'Avoine aux fruits' } } }
              ]
            },
            reward: { pointsEarned: 30 }
          },
          timestamp: new Date().toISOString()
        });
        return;
      }
      
      const planConfig = {
        duration: 'weekly',
        goal: 'balanced_nutrition',
        dietType: 'balanced',
        targetCalories: 2000,
        budget: 50,
        constraints: ['quick_meals'],
        allergies: [],
        preferences: ['mediterranean'],
        startDate: new Date().toISOString().split('T')[0]
      };

      const mealPlan = await mealPlanningService.generateMealPlan(userId, planConfig);
      
      // R√©compenser la planification
      const reward = await gamificationService.awardPoints(userId, 'mealPlanFollowed');

      setResults({
        type: 'meal_plan',
        data: { mealPlan, reward },
        timestamp: new Date().toISOString()
      });

      await loadUserGamificationData();

    } catch (error) {
      console.error('Erreur d√©mo meal planning:', error);
      setResults({
        type: 'error',
        message: error.message
      });
    } finally {
      setLoading(false);
    }
  };

  // ===================
  // DEMO GAMIFICATION
  // ===================
  const handleTestGamification = async () => {
    setLoading(true);
    try {
      console.log('üéÆ D√©marrage d√©mo gamification...');
      
      // Simuler plusieurs actions pour gagner des points
      const actions = [
        { action: 'mealLogged', metadata: { mealType: 'breakfast', nutrition: { protein: 25, carbs: 30, fat: 15 } } },
        { action: 'recipeCompleted', metadata: { difficulty: 'medium', time: 30 } },
        { action: 'fridgeScanned', metadata: { ingredientsCount: 8 } }
      ];

      const results = [];
      for (const { action, metadata } of actions) {
        const result = await gamificationService.awardPoints(userId, action, metadata);
        results.push({ action, result });
        
        // Pause entre les actions
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      // Cr√©er un challenge
      const challenge = await gamificationService.createWeeklyChallenge(userId);

      setResults({
        type: 'gamification',
        data: { actions: results, challenge },
        timestamp: new Date().toISOString()
      });

      await loadUserGamificationData();

    } catch (error) {
      console.error('Erreur d√©mo gamification:', error);
      setResults({
        type: 'error',
        message: error.message
      });
    } finally {
      setLoading(false);
    }
  };

  // ===================
  // DEMO WORKFLOW INT√âGR√â
  // ===================
  const handleIntegratedWorkflow = async () => {
    setLoading(true);
    try {
      console.log('üöÄ D√©marrage workflow int√©gr√©...');
      
      // Simuler donn√©es de repas avec mood
      const mealData = {
        id: `meal_${Date.now()}`,
        type: 'lunch',
        name: 'Salade m√©diterran√©enne',
        nutrition: { calories: 350, protein: 20, carbs: 25, fat: 18, vegetables: 3 },
        cost: 4.50,
        timestamp: new Date().toISOString()
      };

      const moodData = {
        moodScore: 8,
        energy: 7,
        satisfaction: 9,
        notes: 'Repas tr√®s satisfaisant et √©nergisant'
      };

      const workflowResult = await integratedFeaturesService.executeCompleteWorkflow(
        userId,
        'meal_logging_with_rewards',
        { mealData, moodData }
      );

      setResults({
        type: 'integrated_workflow',
        data: workflowResult.results,
        timestamp: new Date().toISOString()
      });

      await loadUserGamificationData();

    } catch (error) {
      console.error('Erreur workflow int√©gr√©:', error);
      setResults({
        type: 'error',
        message: error.message
      });
    } finally {
      setLoading(false);
    }
  };
  // ===================
  // RENDERING
  // ===================
  return (
    <div className="advanced-features-demo">
      <div className="demo-header">
        <h2>üöÄ D√©mo Fonctionnalit√©s Avanc√©es</h2>
        <div className="user-stats">
          <div className="points-display">
            <span className="points-icon">üèÜ</span>
            <span className="points-value">{userPoints}</span>
            <span className="points-label">points</span>
          </div>
          <div className="badges-display">
            <span className="badges-icon">üéñÔ∏è</span>
            <span className="badges-count">{userBadges.length}</span>
            <span className="badges-label">badges</span>
          </div>
        </div>
      </div>

      {/* Information sur le statut des services */}
      {!servicesAvailable && (
        <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
          <div className="flex items-center">
            <span className="text-2xl mr-3">‚ö†Ô∏è</span>
            <div>
              <h3 className="font-bold text-yellow-800">Mode D√©monstration</h3>
              <p className="text-yellow-700">
                Les services avanc√©s sont en cours de chargement. Vous pouvez tester l'interface avec des donn√©es simul√©es.
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Navigation des d√©mos */}
      <div className="demo-navigation">
        <button 
          className={`demo-nav-btn ${activeDemo === 'scanner' ? 'active' : ''}`}
          onClick={() => setActiveDemo('scanner')}
        >
          üì∏ Scanner Frigo
        </button>
        <button 
          className={`demo-nav-btn ${activeDemo === 'planning' ? 'active' : ''}`}
          onClick={() => setActiveDemo('planning')}
        >
          üìÖ Meal Planning
        </button>
        <button 
          className={`demo-nav-btn ${activeDemo === 'gamification' ? 'active' : ''}`}
          onClick={() => setActiveDemo('gamification')}
        >
          üéÆ Gamification
        </button>
        <button 
          className={`demo-nav-btn ${activeDemo === 'integrated' ? 'active' : ''}`}
          onClick={() => setActiveDemo('integrated')}
        >
          üöÄ Workflow Int√©gr√©
        </button>
      </div>

      {/* Contenu des d√©mos */}
      <div className="demo-content">
        {activeDemo === 'scanner' && (
          <div className="demo-section">
            <h3>üì∏ Scanner de Frigo Intelligent</h3>
            <p>Uploadez une photo de votre frigo pour d√©tecter les ingr√©dients et g√©n√©rer automatiquement un plan de repas optimis√©.</p>
            
            <div className="demo-controls">
              <input 
                type="file" 
                accept="image/*" 
                onChange={handleFridgeScan}
                disabled={loading}
                className="file-input"
              />
              {loading && <div className="loading">üîç Analyse en cours...</div>}
            </div>

            <div className="demo-features">
              <div className="feature-item">‚úÖ D√©tection IA des ingr√©dients</div>
              <div className="feature-item">‚úÖ Analyse de fra√Æcheur</div>
              <div className="feature-item">‚úÖ G√©n√©ration automatique de recettes</div>
              <div className="feature-item">‚úÖ Calcul anti-gaspillage</div>
              <div className="feature-item">‚úÖ Points et badges automatiques</div>
            </div>
          </div>
        )}

        {activeDemo === 'planning' && (
          <div className="demo-section">
            <h3>üìÖ Meal Planning Intelligent</h3>
            <p>G√©n√©ration automatique de plans de repas personnalis√©s avec liste de courses et optimisation nutritionnelle.</p>
            
            <div className="demo-controls">
              <button 
                onClick={handleGenerateMealPlan}
                disabled={loading}
                className="demo-action-btn"
              >
                {loading ? 'üìÖ G√©n√©ration...' : 'üìÖ G√©n√©rer Plan de Repas'}
              </button>
            </div>

            <div className="demo-features">
              <div className="feature-item">‚úÖ IA nutritionniste personnalis√©e</div>
              <div className="feature-item">‚úÖ Optimisation automatique du co√ªt</div>
              <div className="feature-item">‚úÖ Calendrier interactif</div>
              <div className="feature-item">‚úÖ Liste de courses intelligente</div>
              <div className="feature-item">‚úÖ Adaptation aux pr√©f√©rences</div>
            </div>
          </div>
        )}

        {activeDemo === 'gamification' && (
          <div className="demo-section">
            <h3>üéÆ Syst√®me de Gamification</h3>
            <p>Points, badges, niveaux et challenges pour motiver vos habitudes alimentaires saines.</p>
            
            <div className="demo-controls">
              <button 
                onClick={handleTestGamification}
                disabled={loading}
                className="demo-action-btn"
              >
                {loading ? 'üéÆ Test en cours...' : 'üéÆ Tester Gamification'}
              </button>
            </div>

            <div className="demo-features">
              <div className="feature-item">‚úÖ Syst√®me de points dynamique</div>
              <div className="feature-item">‚úÖ Badges et achievements</div>
              <div className="feature-item">‚úÖ Challenges hebdomadaires</div>
              <div className="feature-item">‚úÖ Streaks et bonus</div>
              <div className="feature-item">‚úÖ Leaderboard social</div>
            </div>
          </div>
        )}

        {activeDemo === 'integrated' && (
          <div className="demo-section">
            <h3>üöÄ Workflow Int√©gr√©</h3>
            <p>D√©monstration du workflow complet : enregistrement repas + tracking humeur + r√©compenses + insights.</p>
            
            <div className="demo-controls">
              <button 
                onClick={handleIntegratedWorkflow}
                disabled={loading}
                className="demo-action-btn"
              >
                {loading ? 'üöÄ Workflow...' : 'üöÄ Lancer Workflow Complet'}
              </button>
            </div>

            <div className="demo-features">
              <div className="feature-item">‚úÖ Enregistrement automatique</div>
              <div className="feature-item">‚úÖ Tracking humeur et √©nergie</div>
              <div className="feature-item">‚úÖ Attribution points intelligente</div>
              <div className="feature-item">‚úÖ Insights nutritionnels IA</div>
              <div className="feature-item">‚úÖ Recommandations personnalis√©es</div>
            </div>
          </div>
        )}
      </div>

      {/* Affichage des r√©sultats */}
      {results && (
        <div className="demo-results">
          <h3>üìä R√©sultats de la D√©mo</h3>
          <div className="results-container">
            {results.type === 'error' ? (
              <div className="error-result">
                ‚ùå Erreur: {results.message}
              </div>
            ) : (
              <div className="success-result">
                <div className="result-header">
                  ‚úÖ D√©mo {results.type} r√©ussie
                  <span className="timestamp">{new Date(results.timestamp).toLocaleTimeString()}</span>
                </div>
                <pre className="result-data">
                  {JSON.stringify(results.data, null, 2)}
                </pre>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Badges utilisateur */}
      {userBadges.length > 0 && (
        <div className="user-badges">
          <h3>üéñÔ∏è Vos Badges</h3>
          <div className="badges-grid">
            {userBadges.map((badge, index) => (
              <div key={index} className="badge-item">
                <span className="badge-icon">{badge.badge.icon}</span>
                <span className="badge-name">{badge.badge.name}</span>
                <span className="badge-description">{badge.badge.description}</span>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

export default AdvancedFeaturesDemo;