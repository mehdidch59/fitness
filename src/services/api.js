import axios from 'axios';
import { mistralSearchService } from './mistralIntegration';

// Cr√©er une instance pour stocker la r√©f√©rence au hook usePopup
let popupManager = null;

// Fonction d'initialisation pour injecter les popups dans le service API
export const initApiWithPopups = (popupHook) => {
  popupManager = popupHook;
};

// Fonction utilitaire pour afficher des popups (avec fallback console si non disponible)
const showPopupOrConsole = (type, title, message) => {
  if (popupManager) {
    if (type === 'error') {
      popupManager.showErrorPopup(title, message);
    } else if (type === 'info') {
      popupManager.showInfoPopup(title, message);
    } else if (type === 'profile') {
      popupManager.showProfileIncompletePopup();
    }
  } else {
    // Fallback vers console si les popups ne sont pas disponibles
    if (type === 'error') {
      console.error(`${title}: ${message}`);
    } else {
      console.log(`${title}: ${message}`);
    }
  }
};

// Configuration de base d'Axios
const api = axios.create({
  baseURL: process.env.REACT_APP_API_URL || '/api',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  }
});

// Configuration pour activer/d√©sactiver Mistral
const USE_MISTRAL_AI = process.env.REACT_APP_USE_MISTRAL === 'true' || true; // Activ√© par d√©faut
const mistralApiKey = process.env.REACT_APP_MISTRAL_API_KEY;

// V√©rification des variables d'environnement Mistral
if (USE_MISTRAL_AI) {
  if (mistralApiKey) {
    console.log('‚úÖ Mistral AI activ√© pour la g√©n√©ration de contenu fitness');
  } else {
    console.warn('‚ö†Ô∏è Mistral AI activ√© mais cl√© API manquante. D√©finissez REACT_APP_MISTRAL_API_KEY');
    console.warn('Utilisation des fallbacks en cas d\'erreur');
  }
} else {
  console.log('üîç Recherche web classique activ√©e');
}

// Configuration Google Search (fallback si Mistral √©choue)
const googleSearchApiKey = process.env.REACT_APP_GOOGLE_SEARCH_API_KEY;
const googleSearchEngineId = process.env.REACT_APP_GOOGLE_SEARCH_ENGINE_ID;

// Fonction utilitaire pour v√©rifier si l'utilisateur est authentifi√© et a un profil complet
const isUserProfileComplete = () => {
  try {
    // V√©rifier d'abord l'authentification
    const userData = localStorage.getItem('user') || localStorage.getItem('userData') || localStorage.getItem('authUser');
    
    if (!userData) {
      showPopupOrConsole('profile', 'Connexion requise', 'Veuillez vous connecter pour acc√©der √† cette fonctionnalit√©.');
      return false;
    }

    // V√©rifier ensuite le profil utilisateur
    const userProfile = localStorage.getItem('userProfile');
    if (!userProfile) {
      // Pour l'instant, consid√©rer qu'avoir des donn√©es utilisateur suffit
      console.log('‚ö†Ô∏è Profil utilisateur non trouv√© mais utilisateur connect√© - continuons');
      return true; // Permettre l'acc√®s m√™me sans profil complet
    }
    
    const profile = JSON.parse(userProfile);
    // V√©rifier que tous les champs requis sont pr√©sents
    const isComplete = profile && 
           profile.height && 
           profile.weight && 
           profile.age && 
           profile.goal && 
           profile.activityLevel;
           
    if (!isComplete) {
      console.log('‚ö†Ô∏è Profil incomplet mais utilisateur connect√© - continuons');
      return true; // Permettre l'acc√®s m√™me avec profil incomplet
    }
    
    return true;
  } catch (error) {
    console.log('‚ö†Ô∏è Erreur v√©rification profil:', error);
    // En cas d'erreur, v√©rifier au moins si l'utilisateur est connect√©
    const userData = localStorage.getItem('user') || localStorage.getItem('userData') || localStorage.getItem('authUser');
    return !!userData;
  }
};

// Donn√©es de fallback pour les recettes (√† utiliser en cas d'√©chec complet)
const fallbackMassGainRecipes = [
  {
    id: `recipe-mass-${Date.now()}-1`,
    name: 'Poulet teriyaki et riz complet',
    description: 'Riche en prot√©ines et en glucides complexes, parfait pour la prise de masse musculaire.',
    source: 'Fallback interne',
    calories: 650,
    protein: 42,
    time: 30,
    image: 'https://source.unsplash.com/400x300/?chicken+rice',
    aiGenerated: false
  },
  {
    id: `recipe-mass-${Date.now()}-2`,
    name: 'Smoothie prot√©in√© banane et beurre de cacahu√®te',
    description: 'Shake id√©al post-entra√Ænement avec whey, banane, lait et beurre de cacahu√®te.',
    source: 'Fallback interne',
    calories: 580,
    protein: 38,
    time: 5,
    image: 'https://source.unsplash.com/400x300/?protein+smoothie',
    aiGenerated: false
  },
  {
    id: `recipe-mass-${Date.now()}-3`,
    name: 'Bowl de quinoa et b≈ìuf marin√©',
    description: 'Un plat complet riche en prot√©ines, fer et acides amin√©s essentiels pour la croissance musculaire.',
    source: 'Fallback interne',
    calories: 720,
    protein: 45,
    time: 35,
    image: 'https://source.unsplash.com/400x300/?beef+bowl',
    aiGenerated: false
  }
];

// Intercepteur pour ajouter le token d'authentification si disponible
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('authToken');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => Promise.reject(error)
);

// Intercepteur pour g√©rer les erreurs de r√©ponse
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;
    
    // Gestion des erreurs d'authentification (401)
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;
      
      try {
        // Tentative de rafra√Æchissement du token
        const refreshToken = localStorage.getItem('refreshToken');
        if (refreshToken) {
          const response = await axios.post(
            `${process.env.REACT_APP_API_URL}/auth/refresh`,
            { refreshToken }
          );
          
          const { token } = response.data;
          localStorage.setItem('authToken', token);
          
          originalRequest.headers.Authorization = `Bearer ${token}`;
          return api(originalRequest);
        }
      } catch (refreshError) {
        // En cas d'√©chec du rafra√Æchissement, d√©connexion
        localStorage.removeItem('authToken');
        localStorage.removeItem('refreshToken');
        window.location.href = '/login';
      }
    }
    
    return Promise.reject(error);
  }
);

// Service de recherche web/Mistral
export const webSearchService = {
  // Recherche Google/Mistral avec extraction intelligente
  searchGoogle: async (query, userGoal = null) => {
    // V√©rifier que le profil est complet
    if (!isUserProfileComplete()) {
      showPopupOrConsole('error', 'Profil incomplet', 'Veuillez compl√©ter votre profil pour utiliser la recherche personnalis√©e');
      return {
        error: 'PROFILE_INCOMPLETE',
        message: 'Veuillez compl√©ter votre profil pour acc√©der √† la recherche personnalis√©e'
      };
    }
    
    try {
      // ü§ñ UTILISER MISTRAL AI au lieu de Google Search
      if (USE_MISTRAL_AI && mistralApiKey) {
        console.log(`ü§ñ G√©n√©ration avec Mistral AI: "${query}"`);
        return await mistralSearchService.searchGoogle(query, userGoal);
      } else {
        // Fallback vers Google Search si Mistral non disponible
        console.log(`üîç Recherche Google (fallback): "${query}"`);
        return await this.fallbackGoogleSearch(query, userGoal);
      }
      
    } catch (error) {
      console.error('Erreur lors de la recherche:', error);
      showPopupOrConsole('error', 'Erreur de recherche', 'Probl√®me de g√©n√©ration de contenu. Utilisation du contenu de base.');
      return this.simulateEnhancedSearchResults(query, userGoal);
    }
  },
  
  // Recherche automatique de recettes pour prise de masse avec Mistral
  searchMassGainRecipes: async () => {
    // V√©rifier que le profil est complet
    if (!isUserProfileComplete()) {
      console.warn('Profil utilisateur incomplet, recherche non autoris√©e');
      return {
        error: 'PROFILE_INCOMPLETE',
        message: 'Veuillez compl√©ter votre profil pour acc√©der aux recettes personnalis√©es'
      };
    }
    
    try {
      // ü§ñ UTILISER MISTRAL AI pour g√©n√©rer les recettes
      if (USE_MISTRAL_AI && mistralApiKey) {
        console.log('ü•ó G√©n√©ration de recettes prise de masse avec Mistral AI');
        const recipes = await mistralSearchService.searchMassGainRecipes();
        
        // V√©rifier si erreur de profil
        if (recipes.error === 'PROFILE_INCOMPLETE') {
          return recipes;
        }
        
        console.log(`‚úÖ ${recipes.length} recettes g√©n√©r√©es par Mistral AI`);
        return recipes;
      } else {
        // Fallback vers les recettes pr√©d√©finies
        console.log('üîÑ Utilisation des recettes de fallback');
        return fallbackMassGainRecipes;
      }
      
    } catch (error) {
      console.error('Erreur lors de la g√©n√©ration de recettes:', error);
      console.log('üîÑ Utilisation des recettes de fallback');
      return fallbackMassGainRecipes;
    }
  },
  
  // Recherche de programmes d'entra√Ænement avec Mistral
  searchWorkoutPrograms: async (criteria) => {
    // V√©rifier que le profil est complet
    if (!isUserProfileComplete()) {
      console.warn('Profil utilisateur incomplet, recherche non autoris√©e');
      return {
        error: 'PROFILE_INCOMPLETE',
        message: 'Veuillez compl√©ter votre profil pour acc√©der aux programmes personnalis√©s'
      };
    }

    try {
      // ü§ñ UTILISER MISTRAL AI pour g√©n√©rer les programmes
      if (USE_MISTRAL_AI && mistralApiKey) {
        console.log('üí™ G√©n√©ration de programmes avec Mistral AI');
        const programs = await mistralSearchService.searchWorkoutPrograms(criteria);
        
        // V√©rifier si erreur de profil
        if (programs.error === 'PROFILE_INCOMPLETE') {
          return programs;
        }
        
        console.log(`‚úÖ ${programs.length} programmes g√©n√©r√©s par Mistral AI`);
        return programs;
      } else {
        // Fallback vers un programme basique
        return this.getFallbackWorkoutPrograms(criteria);
      }
      
    } catch (error) {
      console.error('Erreur lors de la g√©n√©ration de programmes:', error);
      return this.getFallbackWorkoutPrograms(criteria);
    }
  },
  
  // Recherche de recettes et plans nutritionnels avec Mistral
  searchNutritionPlans: async (criteria) => {
    // V√©rifier que le profil est complet
    if (!isUserProfileComplete()) {
      console.warn('Profil utilisateur incomplet, recherche non autoris√©e');
      return {
        error: 'PROFILE_INCOMPLETE',
        message: 'Veuillez compl√©ter votre profil pour acc√©der aux plans nutritionnels personnalis√©s'
      };
    }
    
    try {
      // ü§ñ UTILISER MISTRAL AI pour g√©n√©rer les plans nutrition
      if (USE_MISTRAL_AI && mistralApiKey) {
        console.log('üçΩÔ∏è G√©n√©ration de plans nutritionnels avec Mistral AI');
        const nutritionPlan = await mistralSearchService.searchNutritionPlans(criteria);
        
        // V√©rifier si erreur de profil
        if (nutritionPlan.error === 'PROFILE_INCOMPLETE') {
          return nutritionPlan;
        }
        
        console.log(`‚úÖ Plan nutritionnel avec ${nutritionPlan.recipes?.length || 0} recettes g√©n√©r√© par Mistral AI`);
        return nutritionPlan;
      } else {
        // Fallback vers un plan basique
        return this.getFallbackNutritionPlans(criteria);
      }
      
    } catch (error) {
      console.error('Erreur lors de la g√©n√©ration de plans nutritionnels:', error);
      return this.getFallbackNutritionPlans(criteria);
    }
  },

  // M√©thodes de fallback (ancien syst√®me)
  fallbackGoogleSearch: async (query, userGoal) => {
    if (!googleSearchApiKey || !googleSearchEngineId) {
      console.warn('üîß API Google indisponible, utilisation de la simulation');
      return this.simulateEnhancedSearchResults(query, userGoal);
    }
    
    try {
      const response = await fetch(
        `https://www.googleapis.com/customsearch/v1?key=${googleSearchApiKey}&cx=${googleSearchEngineId}&q=${encodeURIComponent(query)}&num=8&lr=lang_fr&gl=fr&hl=fr`
      );
      
      if (!response.ok) {
        throw new Error(`Erreur API Google: ${response.status}`);
      }
      
      const data = await response.json();
      return data.items || this.simulateEnhancedSearchResults(query, userGoal);
    } catch (error) {
      console.error('Erreur Google Search:', error);
      return this.simulateEnhancedSearchResults(query, userGoal);
    }
  },

  getFallbackWorkoutPrograms: (criteria) => {
    return [
      {
        id: `fallback-program-${Date.now()}`,
        title: `Programme ${criteria.location === 'home' ? '√† domicile' : 'en salle'}`,
        description: 'Programme personnalis√© adapt√© √† votre profil et votre √©quipement.',
        level: 'Interm√©diaire',
        duration: '4 semaines',
        equipment: criteria.equipment?.length > 0 ? criteria.equipment.join(', ') : 'Aucun',
        source: 'Fallback interne',
        thumbnail: `https://source.unsplash.com/400x300/?fitness+${criteria.location || 'workout'}`,
        workouts: [],
        aiGenerated: false
      }
    ];
  },

  getFallbackNutritionPlans: (criteria) => {
    return {
      id: `fallback-nutrition-${Date.now()}`,
      title: `Plan nutritionnel ${criteria.dietType || 'personnalis√©'}`,
      dietType: criteria.dietType,
      source: 'Fallback interne',
      calorieTarget: 2000,
      recipes: [
        {
          id: `fallback-recipe-${Date.now()}`,
          name: 'Recette √©quilibr√©e de base',
          description: 'Une recette saine et √©quilibr√©e adapt√©e √† vos besoins.',
          calories: 400,
          protein: 25,
          time: 20,
          image: 'https://source.unsplash.com/400x300/?healthy+food',
          source: 'Fallback interne',
          aiGenerated: false
        }
      ],
      aiGenerated: false
    };
  },

  // Simulation am√©lior√©e pour les cas d'urgence
  simulateEnhancedSearchResults: (query, userGoal) => {
    console.log('üîÑ Utilisation de la simulation de recherche');
    
    const baseResults = [
      {
        title: 'Programme fitness personnalis√©',
        snippet: 'Programme adapt√© √† votre profil et vos objectifs sp√©cifiques.',
        link: '#generated-content',
        displayLink: 'fitness-app.local',
        pagemap: { cse_image: [{ src: 'https://source.unsplash.com/400x300/?fitness' }] },
        aiGenerated: false,
        source: 'Simulation'
      },
      {
        title: 'Plan nutritionnel √©quilibr√©',
        snippet: 'Recettes et conseils nutrition adapt√©s √† vos besoins.',
        link: '#nutrition-content',
        displayLink: 'fitness-app.local', 
        pagemap: { cse_image: [{ src: 'https://source.unsplash.com/400x300/?healthy+food' }] },
        aiGenerated: false,
        source: 'Simulation'
      }
    ];
    
    return baseResults;
  }
};

// Services API pour les fonctionnalit√©s de l'application
export const apiService = {
  // Authentification
  auth: {
    login: (credentials) => api.post('/auth/login', credentials),
    register: (userData) => api.post('/auth/register', userData),
    logout: () => api.post('/auth/logout'),
    resetPassword: (email) => api.post('/auth/reset-password', { email }),
  },
  
  // Programmes d'entra√Ænement
  workouts: {
    getAll: () => {
      // En d√©veloppement, simuler les donn√©es
      if (process.env.NODE_ENV === 'development') {
        return Promise.resolve({ data: [] });
      }
      return api.get('/workouts');
    },
    getById: (id) => {
      // En d√©veloppement, simuler les donn√©es
      if (process.env.NODE_ENV === 'development') {
        return Promise.resolve({ data: null });
      }
      return api.get(`/workouts/${id}`);
    },
    create: (workout) => api.post('/workouts', workout),
    update: (id, workout) => api.put(`/workouts/${id}`, workout),
    delete: (id) => api.delete(`/workouts/${id}`),
    // ü§ñ MODIFI√â: Utilise Mistral au lieu de la recherche web
    search: (params) => webSearchService.searchWorkoutPrograms(params)
  },
  
  // Nutrition
  nutrition: {
    getPlans: () => {
      // En d√©veloppement, simuler les donn√©es
      if (process.env.NODE_ENV === 'development') {
        return Promise.resolve({ data: [] });
      }
      return api.get('/nutrition/plans');
    },
    getPlanById: (id) => {
      // En d√©veloppement, simuler les donn√©es
      if (process.env.NODE_ENV === 'development') {
        return Promise.resolve({ data: null });
      }
      return api.get(`/nutrition/plans/${id}`);
    },
    createPlan: (plan) => api.post('/nutrition/plans', plan),
    updatePlan: (id, plan) => api.put(`/nutrition/plans/${id}`, plan),
    deletePlan: (id) => api.delete(`/nutrition/plans/${id}`),
    // ü§ñ MODIFI√â: Utilise Mistral au lieu de la recherche web
    searchRecipes: (params) => webSearchService.searchNutritionPlans(params),
    getMassGainRecipes: () => webSearchService.searchMassGainRecipes()
  },
  
  // Profil utilisateur
  user: {
    getProfile: () => api.get('/user/profile'),
    updateProfile: (profile) => api.put('/user/profile', profile),
    updateSettings: (settings) => api.put('/user/settings', settings),
    uploadAvatar: (formData) => api.post('/user/avatar', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    }),
  },
  
  // Statistiques et suivi
  tracking: {
    getStats: () => api.get('/tracking/stats'),
    logWorkout: (data) => api.post('/tracking/workouts', data),
    logMeal: (data) => api.post('/tracking/meals', data),
    getActivityHistory: (params) => api.get('/tracking/history', { params }),
  }
};

export default api;
